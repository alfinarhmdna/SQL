-- Dataset: Most Streamed Spotify Songs 2023
-- Source: Kaggle https://www.kaggle.com/datasets/nelgiriyewithana/top-spotify-songs-2023
-- Queried using: MYSQL Workbench

CREATE DATABASE spotify;
SELECT * FROM spotify.spotify_2023;  
DROP TABLE IF EXISTS spotify_2023;

SET SQL_SAFE_UPDATES = 0; -- to update field without using primary key
UPDATE spotify_2023 SET artist_name = LTRIM(artist_name); -- remove first space of artist_name field
UPDATE spotify_2023 SET artist_name = TRIM(TRAILING '""' FROM artist_name); -- remove "" at the end of artist_name field

-- What is the average danceability by artist? 
SELECT DISTINCT
	artist_name,
    AVG(danceability) AS avg_danceability 
FROM spotify.spotify_2023
GROUP BY artist_name
ORDER BY avg_danceability DESC;

-- Who are the top 10 artists based on streams, 
-- and what are their tracks' average danceability and energy?
SELECT 
	artist_name,
    SUM(streams) AS sum_streams,
    AVG(danceability) AS avg_danceability,
    AVG(energy) AS avg_energy
FROM spotify_2023
GROUP BY artist_name
ORDER BY sum_streams DESC
LIMIT 10;

-- What is the most charted track in spotify?
SELECT 
	track_name, 
    in_spotify_charts
FROM spotify_2023
ORDER BY in_spotify_charts DESC
LIMIT 1;

-- Showing a table with the popularity rankings for each song key
-- Creating key_mode column
ALTER TABLE spotify_2023 ADD COLUMN key_mode VARCHAR(50);
UPDATE spotify_2023 SET key_mode = CONCAT(song_key, ' ', song_mode);
-- Showing all the song key
SELECT DISTINCT
	key_mode
FROM spotify_2023;
-- Showing which song key is the most used
SELECT DISTINCT
	key_mode,
	COUNT(key_mode) AS number_key_is_used
FROM spotify_2023
GROUP BY key_mode
ORDER BY number_key_is_used DESC;
-- Showing popularity rankings
-- Based on: https://smbutterfield.github.io/ibmt17-18/22-intro-to-non-diatonic-materials/b2-tx-pcintnotation.html
SELECT track_name, key_mode,
CASE
	WHEN key_mode = 'A Major' then 4
    WHEN key_mode = 'A Minor' then 7
    WHEN key_mode = 'A# Major' then 12
    WHEN key_mode = 'A# Minor' then 23                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
    WHEN key_mode = 'B Major' then 18
    WHEN key_mode = 'B Minor' then 14
	WHEN key_mode = 'C# Major' then 16
	WHEN key_mode = 'C# Minor' then 21
	WHEN key_mode = 'D Major' then 2
    WHEN key_mode = 'D Minor' then 10
    WHEN key_mode = 'D# Major' then 11
    WHEN key_mode = 'D# Minor' then 22
    WHEN key_mode = 'E Major' then 5
    WHEN key_mode = 'E Minor' then 8
    WHEN key_mode = 'F Major' then 6
    WHEN key_mode = 'F Minor' then 20
    WHEN key_mode = 'F# Major' then 17
    WHEN key_mode = 'F# Minor' then 15
    WHEN key_mode = 'G Major' then 3
    WHEN key_mode = 'G Minor' then 13
    WHEN key_mode = 'G# Major' then 19
    WHEN key_mode = 'G# Minor' then 24
	else 0
END AS popularity FROM spotify_2023
GROUP BY track_name, key_mode
ORDER BY popularity;

-- Calculate the average spotify playlist for the artists in the 
-- spotify_2023 data table. Then, for every artist with an average 
-- spotify playlist of 15000 or above, show their name, their average 
-- playlist, and label them as a “Top Star."
WITH average_playlist_CTE AS (
	SELECT 
		artist_name,
        ROUND(AVG(in_spotify_playlists)) AS avg_spotify_playlist
	FROM spotify_2023
    GROUP BY artist_name
)
SELECT
	artist_name,
    avg_spotify_playlist,
    'Top Star' AS tag
FROM average_playlist_CTE
WHERE avg_spotify_playlist >= 15000
ORDER BY avg_spotify_playlist DESC;

-- How is the danceability, valence, energy,
-- acousticness, instrumentalness, liveness, speechiness 
-- of the top 15 songs with most streams?
SELECT 
    track_name,
	streams,
	danceability,
    valence,
    energy,
    acousticness,
    instrumentalness,
    liveness,
    speechiness
FROM spotify_2023
ORDER BY streams DESC
LIMIT 15;